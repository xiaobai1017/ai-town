"use client";
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useGameLoop } from "@/hooks/useGameLoop";
import { GameCanvas } from "@/components/GameCanvas";
import { ChatLog } from "@/components/ChatLog";
import { AgentPanel } from "@/components/AgentPanel";
import { HistoryModal } from "@/components/HistoryModal";
import { LocationPanel } from "@/components/LocationPanel";
import { useState } from "react";
import { Play, Pause, User, Plus, Minus, Skull, Banknote, Coins, ShieldAlert } from "lucide-react";
export default function Home() {
    const { gameState, togglePause, setSpeed, speed, addAgent, removeAgent, setPriceLevel, setWageLevel, setRiskLevel } = useGameLoop();
    const [selectedAgent, setSelectedAgent] = useState(null);
    const [selectedLocation, setSelectedLocation] = useState(null);
    const [historyPair, setHistoryPair] = useState(null);
    const handleShowHistory = (nameA, nameB) => {
        const a = gameState.agents.find(ag => ag.name === nameA);
        const b = gameState.agents.find(ag => ag.name === nameB);
        if (a && b)
            setHistoryPair([a, b]);
    };
    const formatTime = (minutes) => {
        const h = Math.floor(minutes / 60) % 24;
        const m = minutes % 60;
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        return `${h12}:${m.toString().padStart(2, '0')} ${ampm}`;
    };
    if (!gameState.world)
        return _jsx("div", { className: "flex items-center justify-center h-screen", children: "Loading town..." });
    return (_jsxs("main", { className: "min-h-screen bg-slate-50 p-8 font-sans text-slate-900", children: [_jsxs("header", { className: "flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200", children: [_jsxs("div", { children: [_jsx("h1", { className: "text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent", children: "AI Town Simulation" }), _jsxs("p", { className: "text-slate-500 text-sm", children: ["Day ", Math.floor(gameState.time / (24 * 60)) + 1, ", ", formatTime(gameState.time)] })] }), _jsxs("div", { className: "flex items-center gap-4", children: [_jsx("div", { className: "flex items-center gap-2 bg-slate-100 p-1 rounded-lg", children: _jsx("button", { onClick: togglePause, className: `p-2 rounded hover:shadow-sm transition ${gameState.isRunning ? 'bg-white text-indigo-600' : 'bg-indigo-600 text-white'}`, children: gameState.isRunning ? _jsx(Pause, { size: 20 }) : _jsx(Play, { size: 20 }) }) }), _jsxs("div", { className: "flex items-center gap-2 text-sm text-slate-600 bg-slate-100 p-1 rounded-lg", children: [_jsxs("span", { className: "px-2 font-medium", children: ["Speed: ", speed, "x"] }), _jsx("button", { onClick: () => setSpeed(1), className: `p-1 px-3 rounded ${speed === 1 ? 'bg-white shadow-sm' : ''}`, children: "1x" }), _jsx("button", { onClick: () => setSpeed(5), className: `p-1 px-3 rounded ${speed === 5 ? 'bg-white shadow-sm' : ''}`, children: "5x" }), _jsx("button", { onClick: () => setSpeed(20), className: `p-1 px-3 rounded ${speed === 20 ? 'bg-white shadow-sm' : ''}`, children: "20x" })] }), _jsxs("div", { className: "ml-4 flex items-center gap-3 bg-slate-100 p-1 rounded-lg", children: [_jsxs("div", { className: "flex items-center gap-1 px-2 border-r border-slate-200", children: [_jsx(User, { size: 16, className: "text-slate-500" }), _jsxs("span", { className: "text-sm font-medium text-slate-600", children: [gameState.agents.length, " Residents"] })] }), _jsxs("div", { className: "flex gap-1", children: [_jsx("button", { onClick: removeAgent, title: "Remove resident", className: "p-1 px-2 hover:bg-white hover:shadow-sm rounded transition text-slate-500 hover:text-red-500", children: _jsx(Minus, { size: 16 }) }), _jsx("button", { onClick: addAgent, title: "Add resident", className: "p-1 px-2 hover:bg-white hover:shadow-sm rounded transition text-slate-500 hover:text-indigo-600", children: _jsx(Plus, { size: 16 }) })] })] }), _jsxs("div", { className: "ml-4 flex items-center gap-4 bg-slate-100 p-1 rounded-lg", children: [_jsxs("div", { className: "flex items-center gap-2 px-2 border-r border-slate-200", children: [_jsx(Banknote, { size: 16, className: "text-emerald-600" }), _jsxs("div", { className: "flex flex-col leading-tight", children: [_jsx("span", { className: "text-[10px] text-slate-500 uppercase font-bold", children: "Wages" }), _jsxs("span", { className: "text-xs font-black text-slate-700", children: [gameState.wageLevel.toFixed(1), "x"] })] }), _jsxs("div", { className: "flex flex-col ml-1", children: [_jsx("button", { onClick: () => setWageLevel(Math.min(5, gameState.wageLevel + 0.1)), className: "hover:text-emerald-600 p-0.5", children: _jsx(Plus, { size: 10 }) }), _jsx("button", { onClick: () => setWageLevel(Math.max(0.1, gameState.wageLevel - 0.1)), className: "hover:text-rose-600 p-0.5", children: _jsx(Minus, { size: 10 }) })] })] }), _jsxs("div", { className: "flex items-center gap-2 px-2 border-r border-slate-200", children: [_jsx(Coins, { size: 16, className: "text-amber-600" }), _jsxs("div", { className: "flex flex-col leading-tight", children: [_jsx("span", { className: "text-[10px] text-slate-500 uppercase font-bold", children: "Prices" }), _jsxs("span", { className: "text-xs font-black text-slate-700", children: [gameState.priceLevel.toFixed(1), "x"] })] }), _jsxs("div", { className: "flex flex-col ml-1", children: [_jsx("button", { onClick: () => setPriceLevel(Math.min(5, gameState.priceLevel + 0.1)), className: "hover:text-amber-600 p-0.5", children: _jsx(Plus, { size: 10 }) }), _jsx("button", { onClick: () => setPriceLevel(Math.max(0.1, gameState.priceLevel - 0.1)), className: "hover:text-rose-600 p-0.5", children: _jsx(Minus, { size: 10 }) })] })] }), _jsxs("div", { className: "flex items-center gap-2 px-2", children: [_jsx(ShieldAlert, { size: 16, className: "text-indigo-600" }), _jsxs("div", { className: "flex flex-col leading-tight", children: [_jsx("span", { className: "text-[10px] text-slate-500 uppercase font-bold", children: "Accident Risk" }), _jsxs("span", { className: "text-xs font-black text-slate-700", children: [gameState.riskLevel.toFixed(1), "x"] })] }), _jsxs("div", { className: "flex flex-col ml-1", children: [_jsx("button", { onClick: () => setRiskLevel(Math.min(10, gameState.riskLevel + 0.5)), className: "hover:text-indigo-600 p-0.5", children: _jsx(Plus, { size: 10 }) }), _jsx("button", { onClick: () => setRiskLevel(Math.max(0, gameState.riskLevel - 0.5)), className: "hover:text-rose-600 p-0.5", children: _jsx(Minus, { size: 10 }) })] })] })] }), _jsxs("div", { className: "flex items-center gap-2 text-sm text-slate-600 bg-purple-50 p-2 rounded-lg", children: [_jsx("span", { className: "text-purple-700 font-bold", children: "\uD83D\uDC51 Charm Rankings:" }), gameState.agents
                                        .sort((a, b) => b.charm - a.charm)
                                        .slice(0, 3)
                                        .map((agent, index) => (_jsxs("span", { onClick: () => setSelectedAgent(agent), className: "flex items-center gap-1 bg-white px-2 py-1 rounded shadow-sm cursor-pointer hover:shadow-md transition-all", children: [_jsxs("span", { className: "text-xs font-black text-purple-600", children: ["#", index + 1] }), _jsx("span", { children: agent.state === 'DEAD' ? 'ðŸª¦' : agent.emoji }), _jsx("span", { className: "font-medium", children: agent.name }), _jsx("span", { className: "text-xs text-purple-600", children: agent.charm })] }, agent.id)))] })] })] }), _jsxs("div", { className: "flex gap-6 items-start justify-center", children: [_jsxs("div", { className: "relative", children: [_jsx("div", { className: "bg-white p-2 rounded-lg shadow-lg border border-slate-200 inline-block", children: _jsx(GameCanvas, { world: gameState.world, agents: gameState.agents, onSelectAgent: (agent) => {
                                        setSelectedAgent(agent);
                                        setSelectedLocation(null);
                                    }, onSelectLocation: (loc) => {
                                        setSelectedLocation(loc);
                                        setSelectedAgent(null);
                                    }, time: gameState.time }) }), _jsx("p", { className: "mt-2 text-center text-slate-400 text-sm", children: "Click on an agent or building for details" })] }), _jsx("div", { className: "flex flex-col gap-6", children: _jsx(ChatLog, { logs: gameState.dialogueLog, onShowHistory: handleShowHistory }) })] }), selectedAgent && (_jsx(AgentPanel, { agent: selectedAgent, allAgents: gameState.agents, onClose: () => setSelectedAgent(null), onShowHistory: (a, b) => setHistoryPair([a, b]) })), selectedLocation && (_jsx(LocationPanel, { location: selectedLocation, onClose: () => setSelectedLocation(null) })), historyPair && (_jsx(HistoryModal, { agentA: historyPair[0], agentB: historyPair[1], onClose: () => setHistoryPair(null) })), (gameState.agents.length > 0 && (gameState.agents.every(a => a.state === 'DEAD') || gameState.agents.some(a => a.charm >= 100))) && (_jsx("div", { className: "fixed inset-0 z-50 flex items-center justify-center bg-slate-950/40 backdrop-blur-sm animate-in fade-in duration-1000", children: _jsxs("div", { className: "bg-slate-900 border-2 border-purple-500/50 p-12 rounded-3xl shadow-[0_0_50px_rgba(124,58,237,0.3)] text-center max-w-md mx-4 transform animate-in zoom-in duration-500", children: [_jsx("div", { className: "w-24 h-24 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-purple-500/30", children: gameState.agents.some(a => a.charm >= 100) ? (_jsx("span", { className: "text-4xl", children: "\uD83D\uDC51" })) : (_jsx(Skull, { size: 48, className: "text-purple-500 animate-pulse" })) }), _jsx("h2", { className: "text-4xl font-black text-white mb-4 tracking-tighter uppercase italic", children: gameState.agents.some(a => a.charm >= 100) ? 'Charm Champion' : 'Final Ranking' }), _jsx("p", { className: "text-slate-400 font-medium leading-relaxed mb-6", children: gameState.agents.some(a => a.charm >= 100) ? (`A resident has reached maximum charm! Here are the final rankings:`) : (`Every resident of AI Town has passed away. Here are the final charm rankings:`) }), _jsxs("div", { className: "bg-slate-950/50 rounded-2xl border border-slate-800 p-4 max-h-64 overflow-y-auto mb-8 text-left", children: [_jsx("h3", { className: "text-[10px] font-black text-purple-500 uppercase tracking-widest mb-4 sticky top-0 bg-slate-900/90 py-1 backdrop-blur-sm border-b border-slate-800", children: "Charm Rankings" }), _jsx("div", { className: "space-y-3", children: gameState.agents
                                        .sort((a, b) => b.charm - a.charm)
                                        .map((a, index) => (_jsxs("div", { onClick: () => setSelectedAgent(a), className: "flex justify-between items-center gap-4 text-sm border-b border-slate-800/50 pb-2 last:border-0 last:pb-0 cursor-pointer hover:bg-white/5 p-1 rounded transition-colors group", children: [_jsxs("div", { className: "flex items-center gap-3", children: [_jsx("span", { className: "text-xl group-hover:scale-110 transition-transform", children: index === 0 ? 'ðŸ‘‘' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : a.state === 'DEAD' ? 'ðŸª¦' : a.emoji }), _jsxs("div", { children: [_jsxs("p", { className: `font-bold leading-none group-hover:text-white ${a.charm >= 100 ? 'text-yellow-400' : 'text-slate-200'}`, children: [a.name, a.charm >= 100 ? ' (Winner!)' : ''] }), _jsx("p", { className: "text-[10px] text-slate-500 mt-1 uppercase font-bold", children: a.role })] })] }), _jsxs("div", { className: "text-right", children: [_jsxs("p", { className: `font-black text-xs ${a.charm >= 100 ? 'text-yellow-400' : 'text-purple-400'}`, children: ["Charm: ", a.charm] }), a.state === 'DEAD' && _jsx("p", { className: "text-rose-400 font-black text-xs", children: a.deathCause }), _jsxs("p", { className: "text-[10px] text-slate-500 font-mono italic", children: ["Survived: ", (a.livingTicks / 60).toFixed(1), " hrs"] })] })] }, a.id))) })] }), _jsx("div", { className: "pt-2 border-t border-slate-800", children: _jsx("button", { onClick: () => window.location.reload(), className: "bg-slate-100 hover:bg-white text-slate-950 font-black py-4 px-10 rounded-2xl transition-all hover:scale-105 active:scale-95 shadow-xl w-full", children: "Restart Simulation" }) })] }) }))] }));
}
